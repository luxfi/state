# Docker image for running historic 7777 network
# Uses official LUX node image with custom genesis

FROM ghcr.io/luxfi/node:latest

# Install additional tools
RUN apt-get update && apt-get install -y \
    curl \
    jq \
    netcat \
    && rm -rf /var/lib/apt/lists/*

# Create directories
RUN mkdir -p /genesis/configs /genesis/chaindata

# Copy 7777 genesis and config
COPY configs/lux-7777 /genesis/configs/lux-7777/
COPY chaindata/lux-7777 /genesis/chaindata/lux-7777/

# Create POA dev config for 7777
RUN cat > /genesis/configs/7777-dev.json << 'EOF'
{
  "network-id": 7777,
  "staking-enabled": false,
  "sybil-protection-enabled": false,
  "health-check-frequency": "5s",
  "snow-sample-size": 1,
  "snow-quorum-size": 1,
  "snow-mixed-query-num-push-vdr": 1,
  "consensus-shutdown-timeout": "1s",
  "chain-config-dir": "/genesis/configs/lux-7777",
  "data-dir": "/data",
  "log-level": "info",
  "http-host": "0.0.0.0",
  "http-port": 9630,
  "staking-port": 9631,
  "api-admin-enabled": true,
  "coreth-config": {
    "snowman-api-enabled": true,
    "eth-apis": ["eth", "web3", "net", "debug", "admin", "personal", "txpool", "miner"],
    "rpc-gas-cap": 100000000,
    "rpc-tx-fee-cap": 100,
    "pruning-enabled": false,
    "metrics-enabled": true,
    "metrics-expensive-enabled": true
  }
}
EOF

# Expose ports
EXPOSE 9630 9631

# Volume for persistent data
VOLUME ["/data"]

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:9630/ext/health || exit 1

# Run with 7777 dev config
CMD ["luxd", "--dev", "--network-id=7777", "--chain-config-dir=/genesis/configs/lux-7777", "--data-dir=/genesis/chaindata/lux-7777/db", "--http-port=9630", "--staking-port=9631"]